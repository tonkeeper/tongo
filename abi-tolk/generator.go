//go:build ignore

package main

import (
	"fmt"
	"go/format"
	"io/fs"
	"os"
	"path/filepath"
	"strings"

	parser "github.com/tonkeeper/tongo/abi-tolk/parser"
	tolkAbi "github.com/tonkeeper/tongo/tolk/abi"
)

const HEADER = `package abi
// Code autogenerated. DO NOT EDIT. 

import (
%v
)

`
const SCHEMAS_PATH = "schemas/"

func main() {
	var abi []tolkAbi.ABI
	filepath.Walk(SCHEMAS_PATH, func(path string, info fs.FileInfo, err error) error {
		if !strings.HasSuffix(info.Name(), ".json") {
			return nil
		}
		scheme, err := os.ReadFile(path)
		if err != nil {
			panic(err)
		}
		a, err := parser.ParseABI(scheme)
		if err != nil {
			panic(err)
		}
		abi = append(abi, a)
		return nil
	})

	gen := parser.NewGenerator(abi)
	types := gen.CollectedTypes()
	msgDecoder := gen.GenerateMsgDecoder()

	getMethods, simpleMethods, err := gen.GetMethods()
	if err != nil {
		panic(err)
	}
	invocationOrder, err := gen.RenderInvocationOrderList(simpleMethods)
	if err != nil {
		panic(err)
	}
	messagesMD, err := gen.RenderMessagesMD()
	if err != nil {
		panic(err)
	}

	contractErrors, err := gen.RenderContractErrors()
	if err != nil {
		panic(err)
	}

	for _, f := range [][]string{
		{types, "types.go", `"github.com/tonkeeper/tongo/tlb"`, `"fmt"`, `"encoding/json"`},
		{msgDecoder, "messages_generated.go", `"github.com/tonkeeper/tongo/tlb"`},
		{getMethods, "get_methods.go", `"context"`, `"fmt"`, `"github.com/tonkeeper/tongo/ton"`, `"github.com/tonkeeper/tongo/tlb"`},
		{invocationOrder, "interfaces.go", `"github.com/tonkeeper/tongo/ton"`},
		{contractErrors, "contracts_errors.go"},
	} {
		file, err := os.Create(f[1])
		if err != nil {
			panic(err)
		}
		code := []byte(fmt.Sprintf(HEADER, strings.Join(f[2:], "\n")) + f[0])
		formatedCode, err := format.Source(code)
		if err != nil {
			formatedCode = code
			//panic(err)
		}
		_, err = file.Write(formatedCode)
		if err != nil {
			panic(err)
		}
		err = file.Close()
		if err != nil {
			panic(err)
		}
	}
	if err := os.WriteFile("messages.md", []byte(messagesMD), 0644); err != nil {
		panic(err)
	}
}
